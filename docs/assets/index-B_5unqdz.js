const S=(t,o)=>t.createdAt.getTime()-o.createdAt.getTime(),Q=(t,o)=>o.committedDate.getTime()-t.committedDate.getTime(),U=(t,o,r)=>{const s=r?`"${r}"`:"null";return`{organization(login: "${t}") {team(slug: "${o}") {repositories(first: 100, after: ${s}) {totalCount pageInfo {endCursor hasNextPage} edges {permission node {name isArchived}}}}}}`},J='ref(qualifiedName:"master") {target {... on Commit {history(first: 25, since: "%s") {nodes {committedDate messageHeadline parents {totalCount} associatedPullRequests(first:5) {nodes { createdAt number title url author { login } repository { name } }}}}}}}',G="pullRequests(last: 15, states: OPEN) { nodes {title url createdAt baseRefName headRefOid isDraft number author { login } comments (first: 50) {nodes {createdAt author { login }}} reviews(first: 50) {nodes {state createdAt author { login }}} commits(last: 1) { nodes { commit { oid statusCheckRollup { state }}}} reviewDecision }}",W=(t,o,r,s="")=>{const n=t==="recent"?J.replace("%s",s):G,c=r.map(l=>`${l.replace(/[^a-zA-Z0-9]/g,"")}:repository(owner: "${o}", name: "${l}") { name ${n} }`).join(" ");return`query ${t}PRs { ${c} }`},K=(t,o)=>Array.from({length:Math.ceil(t.length/o)},(r,s)=>t.slice(s*o,(s+1)*o)),V=t=>new Promise(o=>setTimeout(o,t)),v={fetchBatchQueries:async(t,o,r,s,n)=>{const c=K(s,4);return Promise.all(c.map(async l=>{const a=await fetch("https://api.github.com/graphql",{method:"post",headers:{Authorization:`Bearer ${t}`},body:JSON.stringify({query:W(o,r,l,n)})});if(!a.ok)throw new Error(`GraphQL request failed: ${a.status} ${a.statusText}`);return a.json()}))},queryTeamRepos:async(t,o,r)=>{let s=!0,n=null;const c=[];for(;s;){const l=await fetch("https://api.github.com/graphql",{method:"post",headers:{Authorization:`Bearer ${t}`},body:JSON.stringify({query:U(o,r,n)})});if(!l.ok)throw new Error(`GraphQL request failed: ${l.status} ${l.statusText}`);const g=(await l.json()).data.organization.team.repositories;g.edges.forEach(h=>{h.permission==="ADMIN"&&h.node.isArchived===!1&&c.push(h.node.name)}),s=g.pageInfo.hasNextPage,n=g.pageInfo.endCursor,await V(1e3)}return c},filterTeamRepos:async(t,o,r,s)=>{const n=[],l=Array(20).fill(Promise.resolve()),a=async h=>{try{const d=await fetch(`https://api.github.com/repos/${o}/${h}/teams`,{headers:{Authorization:`Bearer ${t}`}});if(!d.ok)throw new Error(`REST request failed: ${d.status} ${d.statusText}`);const f=await d.json();for(const i of f)if(i.slug===r&&i.permission==="admin"){n.push(h);break}}catch(d){console.error(`Error fetching teams for repo ${h}:`,d)}},g=s.map((h,d)=>{const f=()=>a(h),i=l[d%20].then(f);return l[d%20]=i,i});return await Promise.all(g),n}},C=t=>{t.createdAt=new Date(t.createdAt),t.committedDate&&(t.committedDate=new Date(t.committedDate)),t.reviews?.nodes?.forEach(o=>{o.createdAt=new Date(o.createdAt)}),t.comments?.nodes?.forEach(o=>{o.createdAt=new Date(o.createdAt)})},X=async(t,o,r,s)=>{try{I();const n=r.filter(f=>!s.includes(f)),c=new Date(Date.now()-336*60*60*1e3).toISOString(),l=await v.fetchBatchQueries(t,"recent",o,n,c),a=[];l.forEach(f=>{Object.keys(f.data).forEach(m=>{(f.data[m]?.ref?.target?.history?.nodes??[]).length>0&&a.push(f.data[m].ref)})});const g=[];a.forEach(f=>f.target.history.nodes.forEach(i=>i.parents.totalCount>1?i.associatedPullRequests.nodes.forEach(m=>{m.committedDate=i.committedDate,g.push(m)}):null));const h=[...new Set(g.map(f=>f.url))].map(f=>g.find(i=>i.url===f));h.forEach(C);const d=h.sort(Q);u({recentPRs:d})}catch(n){console.log("Failed to fetch recent PRs",n)}finally{R()}},p=async(t,o,r,s)=>{try{u({isFetchingOpenPRs:!0}),I();const n=r.filter(g=>!s.includes(g)),c=await v.fetchBatchQueries(t,"open",o,n),l=[];c.forEach(g=>{Object.keys(g.data).forEach(d=>{const f=g.data[d].name,i=g.data[d]?.pullRequests.nodes??[];i.length>0&&l.push(...i.map(m=>({...m,repository:{name:f}})))})}),l.forEach(C);const a=l.sort(S).filter(g=>!g.isDraft);u({PRs:a})}catch(n){console.log("Failed to fetch open PRs",n)}finally{R(),u({isFetchingOpenPRs:!1})}},Z=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M256 32C114.6 32 0 125.1 0 240c0 49.6 21.4 95 57 130.7C44.5 421.1 2.7 466 2.2 466.5c-2.2 2.3-2.8 5.7-1.5 8.7S4.8 480 8 480c66.3 0 116-31.8 140.6-51.4 32.7 12.3 69 19.4 107.4 19.4 141.4 0 256-93.1 256-208S397.4 32 256 32zM128 272c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm128 0c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm128 0c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32z" /></svg>',b=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 384 512" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M360 0H24C10.745 0 0 10.745 0 24v16c0 13.255 10.745 24 24 24 0 90.965 51.016 167.734 120.842 192C75.016 280.266 24 357.035 24 448c-13.255 0-24 10.745-24 24v16c0 13.255 10.745 24 24 24h336c13.255 0 24-10.745 24-24v-16c0-13.255-10.745-24-24-24 0-90.965-51.016-167.734-120.842-192C308.984 231.734 360 154.965 360 64c13.255 0 24-10.745 24-24V24c0-13.255-10.745-24-24-24zm-75.078 384H99.08c17.059-46.797 52.096-80 92.92-80 40.821 0 75.862 33.196 92.922 80zm.019-256H99.078C91.988 108.548 88 86.748 88 64h208c0 22.805-3.987 44.587-11.059 64z" /></svg>',M=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M3 13h18v-2H3v2z" /></svg>',N=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 352 512" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z" /></svg>',x=()=>'<svg stroke="currentColor" fill="currentColor" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z" /></svg>',Y=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" /></svg>',ee=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon unreviewed-icon"><title>Unreviewed PR - Needs review</title><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z" /></svg>',te=(t,o)=>{const r=[];t.nodes.forEach(c=>{const l=c.state==="COMMENTED"?"COMMENTED":c.state;r.push({createdAt:c.createdAt,author:c.author.login,state:l})}),o.nodes.forEach(c=>{r.push({createdAt:c.createdAt,author:c.author.login,state:"COMMENTED"})});const s=[];let n=null;return r.sort(S).forEach(c=>{!n||c.author!==n.author||c.state!==n.state?(n&&s.push(n),n={...c,count:1}):n.count=(n.count||1)+1}),n&&s.push(n),s},oe=t=>{const o=Date.now()-t.getTime();return o<36e5?"last-hour":o<72e5?"last-two-hours":o<864e5?"last-day":o<6048e5?"last-week":"over-week-old"},se=(t,o)=>{const r=o.nodes.find(a=>a.commit.oid===t),s={SUCCESS:x(),PENDING:b(),FAILURE:N(),EXPECTED:b(),ERROR:Y()},n=r?.commit?.statusCheckRollup?.state||"ERROR",c=s[n]||M();return`<span class="${n.toLowerCase()}">${c}</span>`},ne=({count:t,author:o,createdAt:r,state:s})=>{const n=(t??1)>1?`(${t})`:"",c=`${o}${n}`,l=r.toLocaleString();let a=`${c} ${s.toLowerCase()} at ${l}`;return s==="APPROVED"?`<span class="event-group approved" title="${a}">${c}${x()}</span>`:s==="CHANGES_REQUESTED"?(a=`${c} requested changes at ${l}`,`<span class="event-group changes-requested" title="${a}">${c}${N()}</span>`):s==="COMMENTED"?(a=`${c} commented at ${l}`,`<span class="event-group commented" title="${a}">${c}${Z()}</span>`):s==="DISMISSED"?(a=`${c} dismissed at ${l}`,`<span class="event-group dismissed" title="${a}">${c}${M()}</span>`):""},re=t=>{const o=Date.now()-t.getTime();if(o<0||isNaN(o))return"Invalid Date";const r=Math.round(o/6e4),s=Math.round(o/864e5),n=Math.round(s/30),c=Math.round(s/360);return r<1?"less than a minute ago":r<45?`${r} minute${r===1?"":"s"} ago`:r<90?"about 1 hour ago":s<1?`about ${Math.floor(r/60)} hour${Math.floor(r/60)===1?"":"s"} ago`:s<30?`${s} day${s===1?"":"s"} ago`:n<12?`about ${n} month${n===1?"":"s"} ago`:`about ${c} year${c===1?"":"s"} ago`},T=(t,o=!0,r=!1)=>{const{number:s,title:n,url:c,repository:l}=t,g=t[o?"committedDate":"createdAt"],h=re(g),d=`pr-time-${t.url}`;if(o)return`<div><span id="${d}" title="${g}">${h}</span> ${t.author.login}&nbsp;<a href="${c}" target="_blank" rel="noopener noreferrer">${l.name}/pull/${s}</a>&nbsp;${n}</div>`;const{createdAt:f,reviews:i,comments:m,baseRefName:w,author:{login:P},headRefOid:k,commits:E}=t,D=te(i,m),_=se(k,E),B=i.nodes.length===0?ee():"",q=`<a href="${c}" target="_blank" rel="noopener noreferrer">${l.name}#${t.number}</a>`,z=r?w:"",F=D.length>0?`<br>&nbsp;&nbsp;${D.map((H,ge)=>ne({...H})).join("")}`:"",j=`<span id="${d}" title="${g}">${h}</span>`;return`<div class="${oe(f)}">${j} ${B} ${_} ${z} ${P} ${q} ${n} ${F}</div>`},ie={config:{token:localStorage.getItem("PR_RADIATOR_TOKEN")||"",owner:localStorage.getItem("PR_RADIATOR_OWNER")||"",team:localStorage.getItem("PR_RADIATOR_TEAM")||"",repos:JSON.parse(localStorage.getItem("PR_RADIATOR_REPOS")||"[]"),ignoreRepos:JSON.parse(localStorage.getItem("PR_RADIATOR_IGNORE_REPOS")||"[]")},PRs:[],recentPRs:[],showDependabotPRs:!1,showMasterPRs:!0,showNeedsReviewPRs:!1,showRecentPRs:!1,showRepoLinks:!1,ignoreMode:!1,selectedRepoIndex:-1,isFetchingOpenPRs:!1};let e={...ie};const y=document.getElementById("progress-bar"),I=()=>{y&&y.classList.add("active")},R=()=>{y&&(y.classList.add("fade-out"),setTimeout(()=>{y&&y.classList.remove("active","fade-out")},300))},u=t=>{e={...e,...t},$()},O=t=>e.config.ignoreRepos.includes(t),L=t=>{const o=[...e.config.ignoreRepos],r=o.indexOf(t);r>-1?o.splice(r,1):o.push(t),u({config:{...e.config,ignoreRepos:o}})},ce=t=>{t.preventDefault();const o=document.getElementById("owner").value,r=document.getElementById("token").value,s=document.getElementById("team").value;localStorage.setItem("PR_RADIATOR_OWNER",o),localStorage.setItem("PR_RADIATOR_TOKEN",r),localStorage.setItem("PR_RADIATOR_TEAM",s),u({config:{...e.config,team:s,token:r,owner:o}}),e.config.token&&e.config.owner&&e.config.repos.length>0?p(e.config.token,e.config.owner,e.config.repos,e.config.ignoreRepos).catch(n=>{console.error("Error fetching PRs after submit",n)}):e.config.token&&e.config.owner&&e.config.team&&e.config.repos.length===0&&(I(),$(),v.queryTeamRepos(r,o,s).then(n=>v.filterTeamRepos(r,o,s,n)).then(n=>{localStorage.setItem("PR_RADIATOR_REPOS",JSON.stringify(n)),u({config:{...e.config,repos:n}}),$(),n.length>0?p(r,o,n,e.config.ignoreRepos).catch(c=>{console.error("Error fetching PRs after repos",c),R()}):R()}).catch(n=>{console.error("Error fetching repos after submit",n),R(),$()}))},A={dependabot:t=>e.showDependabotPRs||t.author.login!=="dependabot",masterPRs:t=>e.showMasterPRs||t.baseRefName!=="master"&&t.baseRefName!=="main",needsReview:t=>!e.showNeedsReviewPRs||t.reviewDecision==="REVIEW_REQUIRED"||t.reviewDecision===null},$=()=>{const{config:{token:t,owner:o,team:r,repos:s,ignoreRepos:n},ignoreMode:c,selectedRepoIndex:l,showRepoLinks:a}=e;document.title="PR Radiator";const g=document.getElementById("root"),h=document.getElementById("settings-form");if(!t||!o||!r){h.style.display="block",g.innerHTML="";return}if(h.style.display="none",s.length===0){g.innerHTML=`<div>Fetching ${r} team repositories...</div>`;return}let d="";if(a){const f=`https://github.com/${o}/`;if(s.length===0)d="<div>No repositories available.</div>";else if(c){const i=s.map((m,w)=>`<li class="${`repo-item ${O(m)?"ignored":""} ${w===l?"selected":""}`}" data-index="${w}" data-repo="${m}">${m}</li>`).join("");d=`
          <h1>${r} repositories (${s.length}) - Edit Ignores (press i to exit)</h1> <!-- UPDATED: Consistent title -->
          <ul id="ignore-list" class="repo-list ignore-mode" tabindex="-1">
            ${i}
          </ul>
          <p>Navigate: j/k or arrows | Toggle: Enter/space or click</p>
        `}else{const i=s.map(m=>`<li class="repo-item ${O(m)?"ignored":""}"><a href="${f}${m}" target="_blank" rel="noopener">${m}</a></li>`).join("");d=`
          <h1>${r} repositories (${s.length}) (i to edit ignores)</h1> <!-- UPDATED: Subtle hint -->
          <ul id="repo-links" class="repo-list static-mode">
            ${i}
          </ul>
        `}if(g.innerHTML=`<div class="App">${d}</div>`,c){const i=document.getElementById("ignore-list");i&&i.focus(),i.querySelectorAll(".repo-item").forEach(w=>{w.addEventListener("click",P=>{const k=P.currentTarget.dataset.repo,E=P.currentTarget;E.classList.add("toggled"),setTimeout(()=>{E&&E.parentNode&&E.classList.remove("toggled")},200),L(k)})})}return}if(e.showRecentPRs)d=e.recentPRs.map(f=>T(f)).join("");else if(e.isFetchingOpenPRs&&e.PRs.length===0)d=`Fetching ${r} pull requests...`;else{const f=e.PRs.filter(A.dependabot).filter(A.masterPRs).filter(A.needsReview);f.length===0?(document.title=`(${f.length}) PR Radiator`,d="No PRs found"):(document.title=`(${f.length}) PR Radiator`,d=f.map(i=>T(i,!1,e.showMasterPRs)).join(""))}g.innerHTML=`<div class="App">${d}</div>`},ae=(t,o)=>{let r=t,s;return s=setInterval(()=>r(),o),()=>clearInterval(s)},le=async()=>{const{config:{token:t,owner:o,team:r,repos:s,ignoreRepos:n}}=e;t&&o&&s.length>0&&await p(t,o,s,n);const c=300*1e3;ae(()=>{t&&o&&s.length>0&&p(t,o,s,n).catch(a=>{console.error("Error in fetchOpenPRs on interval",a)})},c);const l=document.getElementById("settings-form");if(!l.hasAttribute("data-initialized")){const a=document.getElementById("owner"),g=document.getElementById("team"),h=document.getElementById("token");a.value=o,g.value=r,h.value=t,document.getElementById("config-form").addEventListener("submit",ce),l.setAttribute("data-initialized","true")}if(document.addEventListener("keydown",a=>{if(document.getElementById("settings-form").style.display==="block"||document.activeElement.tagName==="INPUT")return;const{showRepoLinks:h,ignoreMode:d}=e;if(h&&d){let i=!0;switch(a.key){case"j":case"ArrowDown":if(e.config.repos.length>0){const m=Math.min(e.config.repos.length-1,e.selectedRepoIndex+1);u({selectedRepoIndex:m})}break;case"k":case"ArrowUp":if(e.config.repos.length>0){const m=Math.max(0,e.selectedRepoIndex-1);u({selectedRepoIndex:m})}break;case"Enter":case" ":if(a.preventDefault(),e.config.repos.length>0&&e.selectedRepoIndex>=0){const m=e.config.repos[e.selectedRepoIndex];L(m)}break;default:i=!1}if(i)return}if(h&&d&&a.key!=="i"&&a.key!=="l")return;const f={d:()=>u({showDependabotPRs:!e.showDependabotPRs}),m:()=>u({showMasterPRs:!e.showMasterPRs}),n:()=>u({showNeedsReviewPRs:!e.showNeedsReviewPRs}),a:()=>{const i=!e.showRecentPRs;u({showRecentPRs:i}),i&&e.config.token&&e.config.owner&&e.config.repos.length>0&&X(e.config.token,e.config.owner,e.config.repos,e.config.ignoreRepos).catch(console.error)},l:()=>{const i=!h;i?u({showRepoLinks:i,ignoreMode:!1,selectedRepoIndex:0,showRecentPRs:!1}):(localStorage.setItem("PR_RADIATOR_IGNORE_REPOS",JSON.stringify(e.config.ignoreRepos)),e.config.token&&e.config.owner&&e.config.repos.length>0&&p(e.config.token,e.config.owner,e.config.repos,e.config.ignoreRepos).catch(console.error),u({showRepoLinks:i,ignoreMode:!1,selectedRepoIndex:-1}))},i:()=>{if(!h)return;const i=!d;i||(localStorage.setItem("PR_RADIATOR_IGNORE_REPOS",JSON.stringify(e.config.ignoreRepos)),e.config.token&&e.config.owner&&e.config.repos.length>0&&p(e.config.token,e.config.owner,e.config.repos,e.config.ignoreRepos).catch(console.error)),u({ignoreMode:i,selectedRepoIndex:i?0:-1})},r:()=>{e.config.token&&e.config.owner&&e.config.repos.length>0&&p(e.config.token,e.config.owner,e.config.repos,e.config.ignoreRepos).catch(console.error)},"\\":()=>{u({config:{...e.config,repos:[]},PRs:[],recentPRs:[]}),I(),$(),v.queryTeamRepos(e.config.token,e.config.owner,e.config.team).then(i=>v.filterTeamRepos(e.config.token,e.config.owner,e.config.team,i)).then(i=>{localStorage.setItem("PR_RADIATOR_REPOS",JSON.stringify(i)),u({config:{...e.config,repos:i}}),$(),i.length>0?p(e.config.token,e.config.owner,i,e.config.ignoreRepos).catch(m=>{console.error("Error fetching PRs after repos",m),R()}):R()}).catch(i=>{console.error("Error fetching repos after submit",i),R(),$()})},"?":()=>{const i=document.getElementById("shortcuts-overlay");i.style.display=i.style.display==="none"?"block":"none"}};f[a.key]&&f[a.key]()}),t&&o&&r&&s.length===0)try{I();const a=await v.queryTeamRepos(t,o,r),g=await v.filterTeamRepos(t,o,r,a);localStorage.setItem("PR_RADIATOR_REPOS",JSON.stringify(g)),u({config:{...e.config,repos:g}})}catch(a){console.error("Error in getTeamRepos",a),R()}document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&t&&o&&s.length>0&&!e.isFetchingOpenPRs&&p(t,o,s,n).catch(a=>{console.error("Error in fetchOpenPRs on tab focus",a)})}),$()};le();
