const k=(e,t)=>e.createdAt.getTime()-t.createdAt.getTime(),H=(e,t)=>t.committedDate.getTime()-e.committedDate.getTime(),Q=(e,t,n)=>{const s=n?`"${n}"`:"null";return`{organization(login: "${e}") {team(slug: "${t}") {repositories(first: 100, after: ${s}) {totalCount pageInfo {endCursor hasNextPage} edges {permission node {name isArchived}}}}}}`},j='ref(qualifiedName:"master") {target {... on Commit {history(first: 25, since: "%s") {nodes {committedDate messageHeadline parents {totalCount} associatedPullRequests(first:5) {nodes { createdAt number title url author { login } repository { name } }}}}}}}',J="pullRequests(last: 15, states: OPEN) { nodes {title url createdAt baseRefName headRefOid isDraft number author { login } comments (first: 50) {nodes {createdAt author { login }}} reviews(first: 50) {nodes {state createdAt author { login }}} commits(last: 1) { nodes { commit { oid statusCheckRollup { state }}}}}}",U=(e,t,n,s="")=>{const o=e==="recent"?j.replace("%s",s):J,r=n.map(c=>`${c.replace(/[^a-zA-Z0-9]/g,"")}:repository(owner: "${t}", name: "${c}") { name ${o} }`).join(" ");return`query ${e}PRs { ${r} }`},G=(e,t)=>Array.from({length:Math.ceil(e.length/t)},(n,s)=>e.slice(s*t,(s+1)*t)),K=e=>new Promise(t=>setTimeout(t,e)),R={fetchBatchQueries:async(e,t,n,s,o)=>{const r=G(s,4);return Promise.all(r.map(async c=>{const a=await fetch("https://api.github.com/graphql",{method:"post",headers:{Authorization:`Bearer ${e}`},body:JSON.stringify({query:U(t,n,c,o)})});if(!a.ok)throw new Error(`GraphQL request failed: ${a.status} ${a.statusText}`);return a.json()}))},queryTeamRepos:async(e,t,n)=>{let s=!0,o=null;const r=[];for(;s;){const c=await fetch("https://api.github.com/graphql",{method:"post",headers:{Authorization:`Bearer ${e}`},body:JSON.stringify({query:Q(t,n,o)})});if(!c.ok)throw new Error(`GraphQL request failed: ${c.status} ${c.statusText}`);const i=(await c.json()).data.organization.team.repositories;i.edges.forEach(d=>{d.permission==="ADMIN"&&d.node.isArchived===!1&&r.push(d.node.name)}),s=i.pageInfo.hasNextPage,o=i.pageInfo.endCursor,await K(1e3)}return r},filterTeamRepos:async(e,t,n,s)=>{const o=[],c=Array(20).fill(Promise.resolve()),a=async d=>{try{const l=await fetch(`https://api.github.com/repos/${t}/${d}/teams`,{headers:{Authorization:`Bearer ${e}`}});if(!l.ok)throw new Error(`REST request failed: ${l.status} ${l.statusText}`);const h=await l.json();for(const u of h)if(u.slug===n&&u.permission==="admin"){o.push(d);break}}catch(l){console.error(`Error fetching teams for repo ${d}:`,l)}},i=s.map((d,l)=>{const h=()=>a(d),u=c[l%20].then(h);return c[l%20]=u,u});return await Promise.all(i),o}},D=e=>{e.createdAt=new Date(e.createdAt),e.committedDate&&(e.committedDate=new Date(e.committedDate)),e.reviews?.nodes?.forEach(t=>{t.createdAt=new Date(t.createdAt)}),e.comments?.nodes?.forEach(t=>{t.createdAt=new Date(t.createdAt)})},W=async(e,t,n,s)=>{try{y();const o=n.filter(h=>!s.includes(h)),r=new Date(Date.now()-336*60*60*1e3).toISOString(),c=await R.fetchBatchQueries(e,"recent",t,o,r),a=[];c.forEach(h=>{Object.keys(h.data).forEach(f=>{(h.data[f]?.ref?.target?.history?.nodes??[]).length>0&&a.push(h.data[f].ref)})});const i=[];a.forEach(h=>h.target.history.nodes.forEach(u=>u.parents.totalCount>1?u.associatedPullRequests.nodes.forEach(f=>{f.committedDate=u.committedDate,i.push(f)}):null));const d=[...new Set(i.map(h=>h.url))].map(h=>i.find(u=>u.url===h));d.forEach(D);const l=d.sort(H);g({recentPRs:l})}catch(o){console.log("Failed to fetch recent PRs",o)}finally{v()}},p=async(e,t,n,s)=>{try{g({isFetchingOpenPRs:!0}),y();const o=n.filter(i=>!s.includes(i)),r=await R.fetchBatchQueries(e,"open",t,o),c=[];r.forEach(i=>{Object.keys(i.data).forEach(l=>{const h=i.data[l].name,u=i.data[l]?.pullRequests.nodes??[];u.length>0&&c.push(...u.map(f=>({...f,repository:{name:h}})))})}),c.forEach(D);const a=c.sort(k).filter(i=>!i.isDraft);g({PRs:a})}catch(o){console.log("Failed to fetch open PRs",o)}finally{v(),g({isFetchingOpenPRs:!1})}},V=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M256 32C114.6 32 0 125.1 0 240c0 49.6 21.4 95 57 130.7C44.5 421.1 2.7 466 2.2 466.5c-2.2 2.3-2.8 5.7-1.5 8.7S4.8 480 8 480c66.3 0 116-31.8 140.6-51.4 32.7 12.3 69 19.4 107.4 19.4 141.4 0 256-93.1 256-208S397.4 32 256 32zM128 272c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm128 0c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm128 0c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32z" /></svg>',A=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 384 512" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M360 0H24C10.745 0 0 10.745 0 24v16c0 13.255 10.745 24 24 24 0 90.965 51.016 167.734 120.842 192C75.016 280.266 24 357.035 24 448c-13.255 0-24 10.745-24 24v16c0 13.255 10.745 24 24 24h336c13.255 0 24-10.745 24-24v-16c0-13.255-10.745-24-24-24 0-90.965-51.016-167.734-120.842-192C308.984 231.734 360 154.965 360 64c13.255 0 24-10.745 24-24V24c0-13.255-10.745-24-24-24zm-75.078 384H99.08c17.059-46.797 52.096-80 92.92-80 40.821 0 75.862 33.196 92.922 80zm.019-256H99.078C91.988 108.548 88 86.748 88 64h208c0 22.805-3.987 44.587-11.059 64z" /></svg>',I=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M3 13h18v-2H3v2z" /></svg>',C=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 352 512" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z" /></svg>',T=()=>'<svg stroke="currentColor" fill="currentColor" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z" /></svg>',X=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" /></svg>',Z=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon unreviewed-icon"><title>Unreviewed PR - Needs review</title><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z" /></svg>',Y=(e,t)=>{const n=[];e.nodes.forEach(r=>{const c=r.state==="COMMENTED"?"COMMENTED":r.state;n.push({createdAt:r.createdAt,author:r.author.login,state:c})}),t.nodes.forEach(r=>{n.push({createdAt:r.createdAt,author:r.author.login,state:"COMMENTED"})});const s=[];let o=null;return n.sort(k).forEach(r=>{!o||r.author!==o.author||r.state!==o.state?(o&&s.push(o),o={...r,count:1}):o.count=(o.count||1)+1}),o&&s.push(o),s},ee=e=>{const t=Date.now()-e.getTime();return t<36e5?"last-hour":t<72e5?"last-two-hours":t<864e5?"last-day":t<6048e5?"last-week":"over-week-old"},te=(e,t)=>{const n=t.nodes.find(a=>a.commit.oid===e),s={SUCCESS:T(),PENDING:A(),FAILURE:C(),EXPECTED:A(),ERROR:X()},o=n?.commit?.statusCheckRollup?.state||"ERROR",r=s[o]||I();return`<span class="${o.toLowerCase()}">${r}</span>`},se=({count:e,author:t,createdAt:n,state:s})=>{const o=(e??1)>1?`(${e})`:"",r=`${t}${o}`,c=n.toLocaleString();let a=`${r} ${s.toLowerCase()} at ${c}`;return s==="APPROVED"?`<span class="event-group approved" title="${a}">${r}${T()}</span>`:s==="CHANGES_REQUESTED"?(a=`${r} requested changes at ${c}`,`<span class="event-group changes-requested" title="${a}">${r}${C()}</span>`):s==="COMMENTED"?(a=`${r} commented at ${c}`,`<span class="event-group commented" title="${a}">${r}${V()}</span>`):s==="DISMISSED"?(a=`${r} dismissed at ${c}`,`<span class="event-group dismissed" title="${a}">${r}${I()}</span>`):""},oe=e=>{const t=Date.now()-e.getTime();if(t<0||isNaN(t))return"Invalid Date";const n=Math.round(t/6e4),s=Math.round(t/864e5),o=Math.round(s/30),r=Math.round(s/360);return n<1?"less than a minute ago":n<45?`${n} minute${n===1?"":"s"} ago`:n<90?"about 1 hour ago":s<1?`about ${Math.floor(n/60)} hour${Math.floor(n/60)===1?"":"s"} ago`:s<30?`${s} day${s===1?"":"s"} ago`:o<12?`about ${o} month${o===1?"":"s"} ago`:`about ${r} year${r===1?"":"s"} ago`},b=(e,t=!0,n=!1)=>{const{number:s,title:o,url:r,repository:c}=e,i=e[t?"committedDate":"createdAt"],d=oe(i),l=`pr-time-${e.url}`;if(t)return`<div><span id="${l}" title="${i}">${d}</span> ${e.author.login}&nbsp;<a href="${r}" target="_blank" rel="noopener noreferrer">${c.name}/pull/${s}</a>&nbsp;${o}</div>`;const{createdAt:h,reviews:u,comments:f,baseRefName:P,author:{login:S},headRefOid:N,commits:M}=e,E=Y(u,f),L=te(N,M),B=u.nodes.length===0?Z():"",q=`<a href="${r}" target="_blank" rel="noopener noreferrer">${c.name}#${e.number}</a>`,_=n?P:"",z=E.length>0?`<br>&nbsp;&nbsp;${E.map((F,ie)=>se({...F})).join("")}`:"",x=`<span id="${l}" title="${i}">${d}</span>`;return`<div class="${ee(h)}">${x} ${B} ${L} ${_} ${S} ${q} ${o} ${z}</div>`},ne={config:{token:localStorage.getItem("PR_RADIATOR_TOKEN")||"",owner:localStorage.getItem("PR_RADIATOR_OWNER")||"",team:localStorage.getItem("PR_RADIATOR_TEAM")||"",repos:JSON.parse(localStorage.getItem("PR_RADIATOR_REPOS")||"[]"),ignoreRepos:JSON.parse(localStorage.getItem("PR_RADIATOR_IGNORE_REPOS")||"[]")},PRs:[],recentPRs:[],showDependabotPRs:!1,showMasterPRs:!0,showNeedsReviewPRs:!1,showRecentPRs:!1,showRepoLinks:!1,isFetchingOpenPRs:!1};let m={...ne};const w=document.getElementById("progress-bar"),y=()=>{w&&w.classList.add("active")},v=()=>{w&&(w.classList.add("fade-out"),setTimeout(()=>{w&&w.classList.remove("active","fade-out")},300))},g=e=>{m={...m,...e},O()},re=e=>{e.preventDefault();const t=document.getElementById("owner").value,n=document.getElementById("token").value,s=document.getElementById("team").value;localStorage.setItem("PR_RADIATOR_OWNER",t),localStorage.setItem("PR_RADIATOR_TOKEN",n),localStorage.setItem("PR_RADIATOR_TEAM",s),g({config:{...m.config,team:s,token:n,owner:t}}),m.config.token&&m.config.owner&&m.config.repos.length>0&&p(m.config.token,m.config.owner,m.config.repos,m.config.ignoreRepos).catch(o=>{console.error("Error fetching PRs after submit",o)})},$={dependabot:e=>m.showDependabotPRs||e.author.login!=="dependabot",masterPRs:e=>m.showMasterPRs||e.baseRefName!=="master"&&e.baseRefName!=="main",needsReview:e=>!m.showNeedsReviewPRs||e.reviews.nodes.length===0},O=()=>{const{config:{token:e,owner:t,team:n,repos:s}}=m;document.title="PR Radiator";const o=document.getElementById("root"),r=document.getElementById("settings-form");if(!e||!t||!n){r.style.display="block",o.innerHTML="";return}if(r.style.display="none",s.length===0){o.innerHTML=`<div>Fetching ${n} team repositories...</div>`;return}const c=m.PRs.filter($.dependabot).filter($.masterPRs).filter($.needsReview);let a="";if(m.showRepoLinks){const i=`https://github.com/${t}/`;a=`<h1>${n} repositories (${s.length})</h1><ul>${s.map(d=>`<li><a href="${i}${d}" target="_blank" rel="noopener">${d}</a></li>`).join("")}</ul>`}else m.showRecentPRs?a=m.recentPRs.map(i=>b(i)).join(""):m.isFetchingOpenPRs&&m.PRs.length===0?a=`Fetching ${n} pull requests...`:c.length===0?(document.title=`(${c.length}) PR Radiator`,a="No PRs found"):(document.title=`(${c.length}) PR Radiator`,a=c.map(i=>b(i,!1,m.showMasterPRs)).join(""));o.innerHTML=`<div class="App">${a}</div>`},ae=(e,t)=>{let n=e,s;return s=setInterval(()=>n(),t),()=>clearInterval(s)},ce=async()=>{const{config:{token:e,owner:t,team:n,repos:s,ignoreRepos:o}}=m;e&&t&&s.length>0&&await p(e,t,s,o);const r=300*1e3;ae(()=>{e&&t&&s.length>0&&p(e,t,s,o).catch(a=>{console.error("Error in fetchOpenPRs on interval",a)})},r);const c=document.getElementById("settings-form");if(!c.hasAttribute("data-initialized")){const a=document.getElementById("owner"),i=document.getElementById("team"),d=document.getElementById("token");a.value=t,i.value=n,d.value=e,document.getElementById("config-form").addEventListener("submit",re),c.setAttribute("data-initialized","true")}if(document.addEventListener("keydown",a=>{if(document.getElementById("settings-form").style.display==="block"||document.activeElement.tagName==="INPUT")return;const d={d:()=>g({showDependabotPRs:!m.showDependabotPRs}),m:()=>g({showMasterPRs:!m.showMasterPRs}),n:()=>g({showNeedsReviewPRs:!m.showNeedsReviewPRs}),a:()=>{const l=!m.showRecentPRs;g({showRecentPRs:l}),l&&e&&t&&s.length>0&&W(e,t,s,o).catch(console.error)},l:()=>g({showRepoLinks:!m.showRepoLinks}),r:()=>{e&&t&&s.length>0&&p(e,t,s,o).catch(console.error)},"\\":()=>{g({config:{...m.config,repos:[]},PRs:[],recentPRs:[]}),R.queryTeamRepos(e,t,n).then(l=>R.filterTeamRepos(e,t,n,l)).then(l=>{localStorage.setItem("PR_RADIATOR_REPOS",JSON.stringify(l)),g({config:{...m.config,repos:l}}),l.length>0&&p(e,t,l,o).catch(console.error)}).catch(l=>{console.error("Error in getTeamRepos",l),v()})},"?":()=>{const l=document.getElementById("shortcuts-overlay");l.style.display=l.style.display==="none"?"block":"none"}};d[a.key]&&d[a.key]()}),e&&t&&n&&s.length===0)try{y();const a=await R.queryTeamRepos(e,t,n),i=await R.filterTeamRepos(e,t,n,a);localStorage.setItem("PR_RADIATOR_REPOS",JSON.stringify(i)),g({config:{...m.config,repos:i}})}catch(a){console.error("Error in getTeamRepos",a),v()}document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&e&&t&&s.length>0&&!m.isFetchingOpenPRs&&p(e,t,s,o).catch(a=>{console.error("Error in fetchOpenPRs on tab focus",a)})}),O()};ce();
