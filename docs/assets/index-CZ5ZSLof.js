(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function r(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(s){if(s.ep)return;s.ep=!0;const n=r(s);fetch(s.href,n)}})();const O=(e,t)=>e.createdAt.getTime()-t.createdAt.getTime(),H=(e,t)=>t.committedDate.getTime()-e.committedDate.getTime(),Q=(e,t,r)=>{const o=r?`"${r}"`:"null";return`{organization(login: "${e}") {team(slug: "${t}") {repositories(first: 100, after: ${o}) {totalCount pageInfo {endCursor hasNextPage} edges {permission node {name isArchived}}}}}}`},j='ref(qualifiedName:"master") {target {... on Commit {history(first: 25, since: "%s") {nodes {committedDate messageHeadline parents {totalCount} associatedPullRequests(first:5) {nodes { createdAt number title url author { login } repository { name } }}}}}}}',J="pullRequests(last: 15, states: OPEN) { nodes {title url createdAt baseRefName headRefOid isDraft number author { login } comments (first: 50) {nodes {createdAt author { login }}} reviews(first: 50) {nodes {state createdAt author { login }}} commits(last: 1) { nodes { commit { oid statusCheckRollup { state }}}}}}",U=(e,t,r,o="")=>{const s=e==="recent"?j.replace("%s",o):J,n=r.map(i=>`${i.replace(/[^a-zA-Z0-9]/g,"")}:repository(owner: "${t}", name: "${i}") { name ${s} }`).join(" ");return`query ${e}PRs { ${n} }`},G=(e,t)=>Array.from({length:Math.ceil(e.length/t)},(r,o)=>e.slice(o*t,(o+1)*t)),K=e=>new Promise(t=>setTimeout(t,e)),R={fetchBatchQueries:async(e,t,r,o,s)=>{const n=G(o,4);return Promise.all(n.map(async i=>{const a=await fetch("https://api.github.com/graphql",{method:"post",headers:{Authorization:`Bearer ${e}`},body:JSON.stringify({query:U(t,r,i,s)})});if(!a.ok)throw new Error(`GraphQL request failed: ${a.status} ${a.statusText}`);return a.json()}))},queryTeamRepos:async(e,t,r)=>{let o=!0,s=null;const n=[];for(;o;){const i=await fetch("https://api.github.com/graphql",{method:"post",headers:{Authorization:`Bearer ${e}`},body:JSON.stringify({query:Q(t,r,s)})});if(!i.ok)throw new Error(`GraphQL request failed: ${i.status} ${i.statusText}`);const c=(await i.json()).data.organization.team.repositories;c.edges.forEach(d=>{d.permission==="ADMIN"&&d.node.isArchived===!1&&n.push(d.node.name)}),o=c.pageInfo.hasNextPage,s=c.pageInfo.endCursor,await K(1e3)}return n},filterTeamRepos:async(e,t,r,o)=>{const s=[],i=Array(20).fill(Promise.resolve()),a=async d=>{try{const l=await fetch(`https://api.github.com/repos/${t}/${d}/teams`,{headers:{Authorization:`Bearer ${e}`}});if(!l.ok)throw new Error(`REST request failed: ${l.status} ${l.statusText}`);const m=await l.json();for(const h of m)if(h.slug===r&&h.permission==="admin"){s.push(d);break}}catch(l){console.error(`Error fetching teams for repo ${d}:`,l)}},c=o.map((d,l)=>{const m=()=>a(d),h=i[l%20].then(m);return i[l%20]=h,h});return await Promise.all(c),s}},I=e=>{e.createdAt=new Date(e.createdAt),e.committedDate&&(e.committedDate=new Date(e.committedDate)),e.reviews?.nodes?.forEach(t=>{t.createdAt=new Date(t.createdAt)}),e.comments?.nodes?.forEach(t=>{t.createdAt=new Date(t.createdAt)})},W=async(e,t,r,o)=>{try{$();const s=r.filter(m=>!o.includes(m)),n=new Date(Date.now()-336*60*60*1e3).toISOString(),i=await R.fetchBatchQueries(e,"recent",t,s,n),a=[];i.forEach(m=>{Object.keys(m.data).forEach(g=>{(m.data[g]?.ref?.target?.history?.nodes??[]).length>0&&a.push(m.data[g].ref)})});const c=[];a.forEach(m=>m.target.history.nodes.forEach(h=>h.parents.totalCount>1?h.associatedPullRequests.nodes.forEach(g=>{g.committedDate=h.committedDate,c.push(g)}):null));const d=[...new Set(c.map(m=>m.url))].map(m=>c.find(h=>h.url===m));d.forEach(I);const l=d.sort(H);f({recentPRs:l})}catch(s){console.log("Failed to fetch recent PRs",s)}finally{v()}},p=async(e,t,r,o)=>{try{f({isFetchingOpenPRs:!0}),$();const s=r.filter(c=>!o.includes(c)),n=await R.fetchBatchQueries(e,"open",t,s),i=[];n.forEach(c=>{Object.keys(c.data).forEach(l=>{const m=c.data[l].name,h=c.data[l]?.pullRequests.nodes??[];h.length>0&&i.push(...h.map(g=>({...g,repository:{name:m}})))})}),i.forEach(I);const a=i.sort(O).filter(c=>!c.isDraft);f({PRs:a})}catch(s){console.log("Failed to fetch open PRs",s)}finally{v(),f({isFetchingOpenPRs:!1})}},V=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M256 32C114.6 32 0 125.1 0 240c0 49.6 21.4 95 57 130.7C44.5 421.1 2.7 466 2.2 466.5c-2.2 2.3-2.8 5.7-1.5 8.7S4.8 480 8 480c66.3 0 116-31.8 140.6-51.4 32.7 12.3 69 19.4 107.4 19.4 141.4 0 256-93.1 256-208S397.4 32 256 32zM128 272c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm128 0c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm128 0c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32z" /></svg>',A=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 384 512" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M360 0H24C10.745 0 0 10.745 0 24v16c0 13.255 10.745 24 24 24 0 90.965 51.016 167.734 120.842 192C75.016 280.266 24 357.035 24 448c-13.255 0-24 10.745-24 24v16c0 13.255 10.745 24 24 24h336c13.255 0 24-10.745 24-24v-16c0-13.255-10.745-24-24-24 0-90.965-51.016-167.734-120.842-192C308.984 231.734 360 154.965 360 64c13.255 0 24-10.745 24-24V24c0-13.255-10.745-24-24-24zm-75.078 384H99.08c17.059-46.797 52.096-80 92.92-80 40.821 0 75.862 33.196 92.922 80zm.019-256H99.078C91.988 108.548 88 86.748 88 64h208c0 22.805-3.987 44.587-11.059 64z" /></svg>',D=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M3 13h18v-2H3v2z" /></svg>',C=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 352 512" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z" /></svg>',k=()=>'<svg stroke="currentColor" fill="currentColor" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z" /></svg>',X=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" /></svg>',Z=()=>'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" class="event-icon unreviewed-icon"><title>Unreviewed PR - Needs review</title><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z" /></svg>',Y=(e,t)=>{const r=[];e.nodes.forEach(n=>{const i=n.state==="COMMENTED"?"COMMENTED":n.state;r.push({createdAt:n.createdAt,author:n.author.login,state:i})}),t.nodes.forEach(n=>{r.push({createdAt:n.createdAt,author:n.author.login,state:"COMMENTED"})});const o=[];let s=null;return r.sort(O).forEach(n=>{!s||n.author!==s.author||n.state!==s.state?(s&&o.push(s),s={...n,count:1}):s.count=(s.count||1)+1}),s&&o.push(s),o},ee=e=>{const t=Date.now()-e.getTime();return t<36e5?"last-hour":t<72e5?"last-two-hours":t<864e5?"last-day":t<6048e5?"last-week":"over-week-old"},te=(e,t)=>{const r=t.nodes.find(a=>a.commit.oid===e),o={SUCCESS:k(),PENDING:A(),FAILURE:C(),EXPECTED:A(),ERROR:X()},s=r?.commit?.statusCheckRollup?.state||"ERROR",n=o[s]||D();return`<span class="${s.toLowerCase()}">${n}</span>`},se=({count:e,author:t,createdAt:r,state:o})=>{const s=(e??1)>1?`(${e})`:"",n=`${t}${s}`,i=r.toLocaleString();let a=`${n} ${o.toLowerCase()} at ${i}`;return o==="APPROVED"?`<span class="event-group approved" title="${a}">${n}${k()}</span>`:o==="CHANGES_REQUESTED"?(a=`${n} requested changes at ${i}`,`<span class="event-group changes-requested" title="${a}">${n}${C()}</span>`):o==="COMMENTED"?(a=`${n} commented at ${i}`,`<span class="event-group commented" title="${a}">${n}${V()}</span>`):o==="DISMISSED"?(a=`${n} dismissed at ${i}`,`<span class="event-group dismissed" title="${a}">${n}${D()}</span>`):""},oe=e=>{const t=Date.now()-e.getTime();if(t<0||isNaN(t))return"Invalid Date";const r=Math.round(t/6e4),o=Math.round(t/864e5),s=Math.round(o/30),n=Math.round(o/360);return r<1?"less than a minute ago":r<45?`${r} minute${r===1?"":"s"} ago`:r<90?"about 1 hour ago":o<1?`about ${Math.floor(r/60)} hour${Math.floor(r/60)===1?"":"s"} ago`:o<30?`${o} day${o===1?"":"s"} ago`:s<12?`about ${s} month${s===1?"":"s"} ago`:`about ${n} year${n===1?"":"s"} ago`},b=(e,t=!0,r=!1)=>{const{number:o,title:s,url:n,repository:i}=e,c=e[t?"committedDate":"createdAt"],d=oe(c),l=`pr-time-${e.url}`;if(t)return`<div><span id="${l}" title="${c}">${d}</span> ${e.author.login}&nbsp;<a href="${n}" target="_blank" rel="noopener noreferrer">${i.name}/pull/${o}</a>&nbsp;${s}</div>`;const{createdAt:m,reviews:h,comments:g,baseRefName:P,author:{login:S},headRefOid:N,commits:M}=e,E=Y(h,g),L=te(N,M),B=h.nodes.length===0?Z():"",q=`<a href="${n}" target="_blank" rel="noopener noreferrer">${i.name}#${e.number}</a>`,_=r?P:"",z=E.length>0?`<br>&nbsp;&nbsp;${E.map((F,ce)=>se({...F})).join("")}`:"",x=`<span id="${l}" title="${c}">${d}</span>`;return`<div class="${ee(m)}">${x} ${B} ${L} ${_} ${S} ${q} ${s} ${z}</div>`},ne={config:{token:localStorage.getItem("PR_RADIATOR_TOKEN")||"",owner:localStorage.getItem("PR_RADIATOR_OWNER")||"",team:localStorage.getItem("PR_RADIATOR_TEAM")||"",repos:JSON.parse(localStorage.getItem("PR_RADIATOR_REPOS")||"[]"),ignoreRepos:JSON.parse(localStorage.getItem("PR_RADIATOR_IGNORE_REPOS")||"[]")},PRs:[],recentPRs:[],showDependabotPRs:!1,showMasterPRs:!0,showNeedsReviewPRs:!1,showRecentPRs:!1,showRepoLinks:!1,isFetchingOpenPRs:!1};let u={...ne};const w=document.getElementById("progress-bar"),$=()=>{w&&w.classList.add("active")},v=()=>{w&&(w.classList.add("fade-out"),setTimeout(()=>{w&&w.classList.remove("active","fade-out")},300))},f=e=>{u={...u,...e},T()},re=e=>{e.preventDefault();const t=document.getElementById("owner").value,r=document.getElementById("token").value,o=document.getElementById("team").value;localStorage.setItem("PR_RADIATOR_OWNER",t),localStorage.setItem("PR_RADIATOR_TOKEN",r),localStorage.setItem("PR_RADIATOR_TEAM",o),f({config:{...u.config,team:o,token:r,owner:t}}),u.config.token&&u.config.owner&&u.config.repos.length>0&&p(u.config.token,u.config.owner,u.config.repos,u.config.ignoreRepos).catch(s=>{console.error("Error fetching PRs after submit",s)})},y={dependabot:e=>u.showDependabotPRs||e.author.login!=="dependabot",masterPRs:e=>u.showMasterPRs||e.baseRefName!=="master"&&e.baseRefName!=="main",needsReview:e=>!u.showNeedsReviewPRs||e.reviews.nodes.length===0},T=()=>{const{config:{token:e,owner:t,team:r,repos:o}}=u;document.title="PR Radiator";const s=document.getElementById("root"),n=document.getElementById("settings-form");if(!e||!t||!r){n.style.display="block",s.innerHTML="";return}if(n.style.display="none",o.length===0){s.innerHTML=`<div>Fetching ${r} team repositories...</div>`;return}const i=u.PRs.filter(y.dependabot).filter(y.masterPRs).filter(y.needsReview);let a="";if(u.showRepoLinks){const c=`https://github.com/${t}/`;a=`<h1>${r} repositories (${o.length})</h1><ul>${o.map(d=>`<li><a href="${c}${d}" target="_blank" rel="noopener">${d}</a></li>`).join("")}</ul>`}else u.showRecentPRs?a=u.recentPRs.map(c=>b(c)).join(""):u.isFetchingOpenPRs&&u.PRs.length===0?a=`Fetching ${r} pull requests...`:i.length===0?(document.title=`(${i.length}) PR Radiator`,a="No PRs found"):(document.title=`(${i.length}) PR Radiator`,a=i.map(c=>b(c,!1,u.showMasterPRs)).join(""));s.innerHTML=`<div class="App">${a}</div>`},ae=(e,t)=>{let r=e,o;return o=setInterval(()=>r(),t),()=>clearInterval(o)},ie=async()=>{const{config:{token:e,owner:t,team:r,repos:o,ignoreRepos:s}}=u;e&&t&&o.length>0&&await p(e,t,o,s);const n=300*1e3;ae(()=>{e&&t&&o.length>0&&p(e,t,o,s).catch(a=>{console.error("Error in fetchOpenPRs on interval",a)})},n);const i=document.getElementById("settings-form");if(!i.hasAttribute("data-initialized")){const a=document.getElementById("owner"),c=document.getElementById("team"),d=document.getElementById("token");a.value=t,c.value=r,d.value=e,document.getElementById("config-form").addEventListener("submit",re),i.setAttribute("data-initialized","true")}if(document.addEventListener("keydown",a=>{if(document.getElementById("settings-form").style.display==="block"||document.activeElement.tagName==="INPUT")return;const d={d:()=>f({showDependabotPRs:!u.showDependabotPRs}),m:()=>f({showMasterPRs:!u.showMasterPRs}),n:()=>f({showNeedsReviewPRs:!u.showNeedsReviewPRs}),a:()=>{const l=!u.showRecentPRs;f({showRecentPRs:l}),l&&e&&t&&o.length>0&&W(e,t,o,s).catch(console.error)},l:()=>f({showRepoLinks:!u.showRepoLinks}),r:()=>{e&&t&&o.length>0&&p(e,t,o,s).catch(console.error)},"\\":()=>{f({config:{...u.config,repos:[]},PRs:[],recentPRs:[]}),R.queryTeamRepos(e,t,r).then(l=>R.filterTeamRepos(e,t,r,l)).then(l=>{localStorage.setItem("PR_RADIATOR_REPOS",JSON.stringify(l)),f({config:{...u.config,repos:l}}),l.length>0&&p(e,t,l,s).catch(console.error)}).catch(l=>{console.error("Error in getTeamRepos",l),v()})},"?":()=>{const l=document.getElementById("shortcuts-overlay");l.style.display=l.style.display==="none"?"block":"none"}};d[a.key]&&d[a.key]()}),e&&t&&r&&o.length===0)try{$();const a=await R.queryTeamRepos(e,t,r),c=await R.filterTeamRepos(e,t,r,a);localStorage.setItem("PR_RADIATOR_REPOS",JSON.stringify(c)),f({config:{...u.config,repos:c}})}catch(a){console.error("Error in getTeamRepos",a),v()}document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&e&&t&&o.length>0&&!u.isFetchingOpenPRs&&p(e,t,o,s).catch(a=>{console.error("Error in fetchOpenPRs on tab focus",a)})}),T()};ie();
